#!/usr/bin/env bash

if [ "$OME_OS" = "$OS_CYGWIN" ]; then
    # STACK_MAJOR_VERSION=1
    # STACK_MINOR_VERSION=9
    # STACK_PATCH_VERSION=1
    # STACK_VERSION=node-v${STACK_MAJOR_VERSION}.${STACK_MINOR_VERSION}.${STACK_PATCH_VERSION}-win-x64
    
    STACK_VERSION=1.9.3

    # tip "set env:$OME_CACHE/$STACK_VERSION"
    export PATH=$OME_CACHE/stack:$PATH
fi

haskell_install_download() {
    if [ "`command -v stack`" = "" ]; then
        if [ "$OME_OS" = "$OS_CYGWIN" ]; then
            local pkgver=stack-${STACK_VERSION}-windows-x86_64
            local zipkg=$pkgver.zip
            
            if [ ! -d $OME_CACHE/$pkgver ]; then
                mkdir -p ~/Downloads
                cd ~/Downloads/
                
                if [ ! -f $HOME/Downloads/$zipkg ]; then
                    # wget https://nodejs.org/dist/latest-v${STACK_MAJOR_VERSION}.x/$zipkg
                    wget -c https://github.com/commercialhaskell/stack/releases/download/v${STACK_VERSION}/$zipkg
                fi
                
                # if [ ! -d $OME_CACHE/$pkgver ]; then
                unzip ./$zipkg -d $OME_CACHE/stack
                cd $OME_CACHE/stack/
                chmod +x ./*
                # fi
            fi
        elif [ "$OME_OS" = "$OS_ARCH" ]; then
            sudo pacman -S stack
        else
            # if test stack = "" ; then
            curl -sSL https://get.haskellstack.org/ | sh
            # or
            # wget -qO- https://get.haskellstack.org/ | sh    
        fi
    fi
}

haskell_install_bin() {
    get_os_type
    case $OME_OS in
        # Linux
        # $OS_DEBIAN) ;;
        # $OS_UBUNTU) ;;
        $OS_DEBIAN|$OS_UBUNTU) ;;
        # $OS_REDHAT) ;;
        # $OS_FEDORA) ;;
        $OS_REDHAT|$OS_FEDORA) sudo yum install stack;;
        $OS_ARCH) sudo pacman -S statck;;
        $OS_GENTOO) ;;
        $OS_SUSE)
            # openSUSE Leap
            sudo zypper ar http://download.opensuse.org/repositories/devel:/languages:/haskell/openSUSE_Leap_42.1/devel:languages:haskell.repo
            # SUSE Linux Enterprise 12
            sudo zypper ar http://download.opensuse.org/repositories/devel:/languages:/haskell/SLE_12/devel:languages:haskell.repo
            ;;
        $OS_SLACKWARE) ;;
        $OS_NIXOS) ;;
        $OS_VOID) ;;
        $OS_ALPINE) ;;
        $OS_MAGEIA) ;;
        $OS_SLITAZ) ;;
        $OS_GUIXSD) ;;
        # Unix
        $OS_MACOS) ;;
        $OS_AIX) ;;
        $OS_SOLARIS) ;;
        $OS_FREEBSD) ;;
        $OS_OPENBSD) ;;
        $OS_NETBSD) ;;
        $OS_DFBSD) ;;
        # Windows
        $OS_CYGWIN) ;;
        $OS_MSYS2) ;;
        # Other
        $OS_UNKNOW) ;;
    esac

}

haskell_install()
{
    haskell_install_download
    # haskell_install_bin
    
    tip "stack upgrade"
    stack upgrade
}

haskell_uninstall() {
    echo_error "'haskell_uninstall' not implemented"
}

haskell_exist_p() {
    echo_error "'haskell_exist_p' not implemented"
}

haskell_info() {
    if [ "`command -v stack`" != "" ]; then
        ome_info "Haskell" "Stack `stack --version | cut -c 9-13`"
    fi
}
